<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Image Compressor - Privacy First</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', Roboto, sans-serif;
      background: #000;
      color: #f5f5f7;
      line-height: 1.6;
      overflow-x: hidden;
    }

    .hero {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      padding: 60px 20px;
      background: linear-gradient(180deg, #000 0%, #1a1a1a 100%);
    }

    .hero-title {
      font-size: clamp(3rem, 8vw, 6rem);
      font-weight: 600;
      letter-spacing: -0.03em;
      margin-bottom: 20px;
      background: linear-gradient(90deg, #fff 0%, #999 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .hero-subtitle {
      font-size: clamp(1.2rem, 3vw, 1.8rem);
      font-weight: 400;
      color: #86868b;
      margin-bottom: 30px;
      max-width: 800px;
    }

    .security-tag {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: rgba(16, 185, 129, 0.15);
      border: 1px solid rgba(16, 185, 129, 0.3);
      color: #10b981;
      padding: 12px 24px;
      border-radius: 50px;
      font-size: 0.9rem;
      font-weight: 500;
      margin-bottom: 50px;
      backdrop-filter: blur(10px);
    }

    .upload-section {
      max-width: 1000px;
      margin: 0 auto;
      padding: 20px;
    }

    .upload-zone {
      border: 2px dashed rgba(255,255,255,0.2);
      border-radius: 20px;
      padding: 80px 40px;
      text-align: center;
      cursor: pointer;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      background: rgba(255,255,255,0.03);
      backdrop-filter: blur(20px);
    }

    .upload-zone:hover {
      border-color: rgba(255,255,255,0.4);
      background: rgba(255,255,255,0.05);
      transform: scale(1.01);
    }

    .upload-zone.dragover {
      border-color: #0071e3;
      background: rgba(0,113,227,0.1);
    }

    .upload-icon {
      font-size: 4rem;
      margin-bottom: 20px;
      filter: grayscale(0.3);
    }

    .upload-text {
      font-size: 1.5rem;
      font-weight: 500;
      color: #f5f5f7;
      margin-bottom: 10px;
    }

    .upload-subtext {
      color: #86868b;
      font-size: 1rem;
    }

    #fileInput {
      display: none;
    }

    .preview-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.95);
      z-index: 1000;
      backdrop-filter: blur(20px);
    }

    .preview-modal.active {
      display: block;
    }

    .modal-content {
      max-width: 1400px;
      margin: 0 auto;
      padding: 60px 40px;
      height: 100%;
      display: flex;
      flex-direction: column;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
    }

    .modal-title {
      font-size: 1.8rem;
      font-weight: 600;
      color: #f5f5f7;
    }

    .close-btn {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: rgba(255,255,255,0.1);
      border: none;
      color: #f5f5f7;
      font-size: 1.5rem;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .close-btn:hover {
      background: rgba(255,255,255,0.2);
      transform: rotate(90deg);
    }

    .comparison-container {
      flex: 1;
      position: relative;
      border-radius: 20px;
      overflow: hidden;
      background: #1a1a1a;
      margin-bottom: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .comparison-wrapper {
      position: relative;
      max-width: 100%;
      max-height: 100%;
      display: inline-block;
    }

    .comparison-images {
      position: relative;
      user-select: none;
    }

    .comparison-img {
      display: block;
      max-width: 100%;
      max-height: 70vh;
      width: auto;
      height: auto;
    }

    .compressed-layer {
      position: absolute;
      top: 0;
      left: 0;
      width: 50%;
      height: 100%;
      overflow: hidden;
    }

    .compressed-layer img {
      position: absolute;
      top: 0;
      left: 0;
      max-width: none;
      width: 100%;
      height: 100%;
      object-fit: contain;
    }

    .slider-handle {
      position: absolute;
      top: 0;
      left: 50%;
      width: 4px;
      height: 100%;
      background: #0071e3;
      cursor: ew-resize;
      transform: translateX(-50%);
      z-index: 10;
    }

    .slider-button {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 60px;
      height: 60px;
      background: #0071e3;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 20px rgba(0,113,227,0.5);
    }

    .slider-arrow {
      width: 0;
      height: 0;
      border-style: solid;
      position: absolute;
    }

    .slider-arrow-left {
      border-width: 8px 12px 8px 0;
      border-color: transparent #fff transparent transparent;
      left: 16px;
    }

    .slider-arrow-right {
      border-width: 8px 0 8px 12px;
      border-color: transparent transparent transparent #fff;
      right: 16px;
    }

    .image-labels {
      position: absolute;
      top: 20px;
      width: 100%;
      display: flex;
      justify-content: space-between;
      padding: 0 20px;
      pointer-events: none;
    }

    .label {
      background: rgba(0,0,0,0.7);
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 0.9rem;
      font-weight: 500;
      backdrop-filter: blur(10px);
    }

    .label-original {
      color: #ff3b30;
    }

    .label-compressed {
      color: #10b981;
    }

    .controls {
      background: rgba(255,255,255,0.05);
      border-radius: 20px;
      padding: 30px;
      backdrop-filter: blur(20px);
    }

    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-item {
      text-align: center;
    }

    .stat-label {
      font-size: 0.9rem;
      color: #86868b;
      margin-bottom: 5px;
    }

    .stat-value {
      font-size: 1.5rem;
      font-weight: 600;
      color: #f5f5f7;
    }

    .stat-value.savings {
      color: #10b981;
    }

    .quality-control {
      margin-bottom: 30px;
    }

    .quality-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    .quality-label {
      font-size: 1rem;
      color: #f5f5f7;
    }

    .quality-value {
      font-size: 1.2rem;
      font-weight: 600;
      color: #0071e3;
    }

    .quality-slider {
      width: 100%;
      height: 6px;
      border-radius: 3px;
      outline: none;
      -webkit-appearance: none;
      background: linear-gradient(90deg, #ff3b30 0%, #ffcc00 50%, #10b981 100%);
      cursor: pointer;
    }

    .quality-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: #fff;
      cursor: pointer;
      box-shadow: 0 2px 10px rgba(0,0,0,0.3);
    }

    .quality-slider::-moz-range-thumb {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: #fff;
      cursor: pointer;
      box-shadow: 0 2px 10px rgba(0,0,0,0.3);
      border: none;
    }

    .action-buttons {
      display: flex;
      gap: 15px;
    }

    .btn {
      flex: 1;
      padding: 16px 32px;
      border: none;
      border-radius: 12px;
      font-size: 1rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
      font-family: inherit;
    }

    .btn-primary {
      background: #0071e3;
      color: #fff;
    }

    .btn-primary:hover {
      background: #0077ed;
      transform: translateY(-2px);
      box-shadow: 0 10px 30px rgba(0,113,227,0.3);
    }

    .btn-secondary {
      background: rgba(255,255,255,0.1);
      color: #f5f5f7;
    }

    .btn-secondary:hover {
      background: rgba(255,255,255,0.15);
    }

    .algorithm-badge {
      position: absolute;
      top: 20px;
      right: 20px;
      background: rgba(0,113,227,0.2);
      border: 1px solid rgba(0,113,227,0.4);
      color: #0071e3;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: 500;
      backdrop-filter: blur(10px);
      pointer-events: none;
    }

    .processing-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.8);
      display: none;
      align-items: center;
      justify-content: center;
      border-radius: 20px;
      backdrop-filter: blur(10px);
    }

    .processing-overlay.active {
      display: flex;
    }

    .spinner {
      width: 50px;
      height: 50px;
      border: 3px solid rgba(255,255,255,0.1);
      border-top-color: #0071e3;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .features {
      max-width: 1000px;
      margin: 100px auto;
      padding: 20px;
    }

    .features-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 40px;
      margin-top: 60px;
    }

    .feature {
      text-align: center;
    }

    .feature-icon {
      font-size: 3rem;
      margin-bottom: 20px;
      filter: grayscale(0.3);
    }

    .feature-title {
      font-size: 1.3rem;
      font-weight: 600;
      color: #f5f5f7;
      margin-bottom: 10px;
    }

    .feature-description {
      color: #86868b;
      font-size: 1rem;
      line-height: 1.6;
    }

    @media (max-width: 768px) {
      .modal-content {
        padding: 40px 20px;
      }

      .stats {
        grid-template-columns: 1fr;
        gap: 15px;
      }

      .action-buttons {
        flex-direction: column;
      }

      .comparison-img {
        max-height: 50vh;
      }
    }
  </style>
</head>
<body>
  <div class="hero">
    <h1 class="hero-title">Image Compressor</h1>
    <p class="hero-subtitle">AI-powered compression with advanced subject detection</p>
    <div class="security-tag">
      ðŸ”’ 100% Private â€¢ No Server Upload â€¢ Zero Data Collection
    </div>
    
    <div class="upload-section">
      <div class="upload-zone" id="uploadZone">
        <div class="upload-icon">ðŸ“¸</div>
        <div class="upload-text">Drop your images here</div>
        <div class="upload-subtext">or click to browse â€¢ JPEG, PNG, WEBP</div>
      </div>
      <input type="file" id="fileInput" accept="image/jpeg,image/png,image/webp" multiple>
    </div>
  </div>

  <div class="features">
    <div class="features-grid">
      <div class="feature">
        <div class="feature-icon">ðŸ§ </div>
        <h3 class="feature-title">Smart Subject Detection</h3>
        <p class="feature-description">AI algorithm detects subjects and preserves detail while aggressively compressing backgrounds</p>
      </div>
      <div class="feature">
        <div class="feature-icon">âš¡</div>
        <h3 class="feature-title">Instant Processing</h3>
        <p class="feature-description">No uploads, no waiting. Everything happens in your browser at lightning speed</p>
      </div>
      <div class="feature">
        <div class="feature-icon">ðŸ”’</div>
        <h3 class="feature-title">Complete Privacy</h3>
        <p class="feature-description">Your images never leave your device. Zero tracking, zero data collection</p>
      </div>
    </div>
  </div>

  <div class="preview-modal" id="previewModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title" id="modalTitle">Image Preview</h2>
        <button class="close-btn" onclick="closePreview()">Ã—</button>
      </div>

      <div class="comparison-container">
        <div class="algorithm-badge">AI Subject Detection Active</div>
        <div class="processing-overlay" id="processingOverlay">
          <div class="spinner"></div>
        </div>
        
        <div class="comparison-wrapper" id="comparisonWrapper">
          <div class="comparison-images" id="comparisonImages">
            <img id="originalImg" class="comparison-img" alt="Original">
            <div class="compressed-layer" id="compressedLayer">
              <img id="compressedImg" alt="Compressed">
            </div>
            <div class="slider-handle" id="sliderHandle">
              <div class="slider-button">
                <div class="slider-arrow slider-arrow-left"></div>
                <div class="slider-arrow slider-arrow-right"></div>
              </div>
            </div>
            <div class="image-labels">
              <span class="label label-original">Original</span>
              <span class="label label-compressed">Compressed</span>
            </div>
          </div>
        </div>
      </div>

      <div class="controls">
        <div class="stats">
          <div class="stat-item">
            <div class="stat-label">Original Size</div>
            <div class="stat-value" id="originalSize">--</div>
          </div>
          <div class="stat-item">
            <div class="stat-label">Compressed Size</div>
            <div class="stat-value" id="compressedSize">--</div>
          </div>
          <div class="stat-item">
            <div class="stat-label">Savings</div>
            <div class="stat-value savings" id="savings">--</div>
          </div>
        </div>

        <div class="quality-control">
          <div class="quality-header">
            <span class="quality-label">Compression Quality</span>
            <span class="quality-value" id="qualityValue">80%</span>
          </div>
          <input type="range" class="quality-slider" id="qualitySlider" min="10" max="100" value="80">
        </div>

        <div class="action-buttons">
          <button class="btn btn-primary" onclick="downloadCompressed()">Download Compressed</button>
          <button class="btn btn-secondary" onclick="closePreview()">Close</button>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
import { ImagePool } from "https://cdn.jsdelivr.net/npm/@squoosh/lib@0.5.0/+esm";

// --- Prevent browser from opening dropped files globally ---
['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
  document.addEventListener(eventName, e => {
    e.preventDefault();
    e.stopPropagation();
  });
});

// --- Config ---
const MAX_DIMENSION = 2500;
const MAX_PIXELS = 8_000_000;
const ENTROPY_SAMPLE = 256;
const TWO_PASS_ENCODE = true;
const DEFAULT_QUALITY = 0.80;

// --- State & DOM refs ---
let currentImage = null;
let isDragging = false;

const uploadZone = document.getElementById('uploadZone');
const fileInput = document.getElementById('fileInput');
const previewModal = document.getElementById('previewModal');
const sliderHandle = document.getElementById('sliderHandle');
const compressedLayer = document.getElementById('compressedLayer');
const qualitySlider = document.getElementById('qualitySlider');
const processingOverlay = document.getElementById('processingOverlay');
// --- Prevent browser navigation on accidental file drop ---
window.addEventListener('dragover', (e) => e.preventDefault());
window.addEventListener('drop', (e) => e.preventDefault());

if (!uploadZone || !fileInput) {
  console.error('Missing required DOM elements: uploadZone or fileInput');
}

// --- UI wiring ---
uploadZone.addEventListener('click', () => fileInput.click());

uploadZone.addEventListener('dragover', (e) => {
  e.preventDefault();
  uploadZone.classList.add('dragover');
});

uploadZone.addEventListener('dragleave', () => {
  uploadZone.classList.remove('dragover');
});

uploadZone.addEventListener('drop', (e) => {
  e.preventDefault();
  uploadZone.classList.remove('dragover');

  let files = [];
  if (e.dataTransfer && e.dataTransfer.files && e.dataTransfer.files.length) {
    files = Array.from(e.dataTransfer.files).filter(f => f.type && f.type.startsWith('image/'));
  } else if (e.dataTransfer && e.dataTransfer.items) {
    files = Array.from(e.dataTransfer.items)
      .map(it => it.getAsFile ? it.getAsFile() : null)
      .filter(Boolean)
      .filter(f => f.type && f.type.startsWith('image/'));
  }

  if (files.length > 0) handleFile(files[0]);
});

fileInput.addEventListener('change', (e) => {
  if (e.target.files && e.target.files.length > 0) handleFile(e.target.files[0]);
});

qualitySlider.addEventListener('input', (e) => {
  document.getElementById('qualityValue').textContent = e.target.value + '%';
});

qualitySlider.addEventListener('change', async (e) => {
  const quality = e.target.value / 100;
  await compressWithQuality(quality);
});

// --- Main handlers ---
async function handleFile(file) {
  try {
    if (!file) return;
    currentImage = {
      file,
      name: file.name,
      originalSize: file.size,
      type: file.type
    };

    const img = await loadImage(file);
    currentImage.img = img;

    document.getElementById('modalTitle').textContent = file.name;
    document.getElementById('originalImg').src = img.src;
    document.getElementById('originalSize').textContent = formatBytes(file.size);

    previewModal.classList.add('active');
    await compressWithQuality(DEFAULT_QUALITY);
    updateSliderPosition(50);
  } catch (err) {
    console.error('handleFile error:', err);
    alert('Failed to load image â€” check console for details.');
  }
}

async function compressWithQuality(quality) {
  if (!currentImage || !currentImage.img) return;

  processingOverlay.classList.add('active');
  await new Promise(r => setTimeout(r, 80));

  try {
    const compressed = await advancedCompress(currentImage.img, quality, currentImage.type);

    if (currentImage.compressedUrl) {
      try { URL.revokeObjectURL(currentImage.compressedUrl); } catch (e) {}
      currentImage.compressedUrl = null;
    }

    currentImage.compressed = compressed.blob;
    currentImage.compressedUrl = compressed.dataUrl;
    currentImage.compressedSize = compressed.blob.size;

    document.getElementById('compressedImg').src = compressed.dataUrl;
    document.getElementById('compressedSize').textContent = formatBytes(compressed.blob.size);

    const savings = ((1 - compressed.blob.size / currentImage.originalSize) * 100).toFixed(1);
    document.getElementById('savings').textContent = savings + '%';
  } catch (err) {
    console.error('Compression failed:', err);
    alert('Compression failed â€” check console for details.');
  } finally {
    processingOverlay.classList.remove('active');
  }
}

// --- Advanced compression pipeline ---
async function advancedCompress(img, quality, mimeType) {
  try {
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d', { willReadFrequently: true });

    let scale = 1;
    if (img.width * img.height > MAX_PIXELS) {
      scale = Math.min(scale, Math.sqrt(MAX_PIXELS / (img.width * img.height)));
    }
    if (Math.max(img.width, img.height) > MAX_DIMENSION) {
      scale = Math.min(scale, MAX_DIMENSION / Math.max(img.width, img.height));
    }

    canvas.width = Math.max(1, Math.round(img.width * scale));
    canvas.height = Math.max(1, Math.round(img.height * scale));
    ctx.imageSmoothingEnabled = true;
    ctx.imageSmoothingQuality = 'high';
    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

    const entropy = await estimateEntropy(ctx, canvas);
    let targetType = entropy > 5.0 ? 'image/avif' : 'image/webp';

    try {
      const test = document.createElement('canvas').toDataURL(targetType);
      if (!test.startsWith(`data:${targetType}`)) targetType = 'image/webp';
    } catch {
      targetType = 'image/webp';
    }

    const sourceBlob = await new Promise((res) => {
      if (canvas.convertToBlob) {
        canvas.convertToBlob({ type: 'image/png' }).then(res).catch(() => canvas.toBlob(res, 'image/png'));
      } else {
        canvas.toBlob(res, 'image/png');
      }
    });

    const pool = new ImagePool(navigator.hardwareConcurrency || 2);
    const image = pool.ingestImage(sourceBlob);

    const codec = targetType.split('/')[1];
    const lossless = quality >= 0.995;

    const baseEncoders = {
      avif: { cqLevel: Math.round((1 - quality) * 62), effort: 4, lossless: !!lossless },
      webp: { quality: Math.round(quality * 100), lossless: !!lossless },
      mozjpeg: { quality: Math.round(quality * 100) }
    };

    const runEncode = async (encOptions) => {
      await image.encode(encOptions);
      const encoded = image.encodedWith.avif || image.encodedWith.webp || image.encodedWith.mozjpeg;
      if (!encoded) throw new Error('No encoded result returned');
      return { binary: encoded.binary, mime: encoded.mimeType || targetType, size: encoded.binary.byteLength };
    };

    let chosen;
    try {
      const enc1 = { [codec]: { ...baseEncoders[codec], effort: baseEncoders[codec].effort || 4 } };
      const pass1 = await runEncode(enc1);
      chosen = pass1;

      if (TWO_PASS_ENCODE) {
        const enc2 = { [codec]: { ...baseEncoders[codec], effort: (baseEncoders[codec].effort || 4) + 2 } };
        await image.encode(enc2);
        const pass2 = image.encodedWith.avif || image.encodedWith.webp || image.encodedWith.mozjpeg;
        if (pass2 && pass2.binary && pass2.binary.byteLength < pass1.binary.byteLength) {
          chosen = { binary: pass2.binary, mime: pass2.mimeType || targetType, size: pass2.binary.byteLength };
        }
      }
    } catch (err) {
      console.warn('Two-pass encode failed, trying fallback webp:', err);
      try {
        await image.encode({ webp: baseEncoders.webp });
        const fallback = image.encodedWith.webp;
        chosen = { binary: fallback.binary, mime: 'image/webp', size: fallback.binary.byteLength };
      } catch (err2) {
        console.error('Fallback encode failed:', err2);
        await pool.close();
        return { blob: sourceBlob, dataUrl: URL.createObjectURL(sourceBlob) };
      }
    }

    const finalBlob = new Blob([chosen.binary], { type: chosen.mime });
    const finalUrl = URL.createObjectURL(finalBlob);
    await pool.close();
    return { blob: finalBlob, dataUrl: finalUrl };
  } catch (err) {
    console.error('advancedCompress top-level error:', err);
    throw err;
  }
}

// --- Entropy estimation ---
async function estimateEntropy(ctx, canvas) {
  const w = Math.min(canvas.width, ENTROPY_SAMPLE);
  const h = Math.min(canvas.height, ENTROPY_SAMPLE);
  try {
    const imgd = ctx.getImageData(0, 0, w, h);
    const data = imgd.data;
    const hist = new Uint32Array(256);
    let total = 0;
    for (let i = 0; i < data.length; i += 4) {
      const r = data[i], g = data[i + 1], b = data[i + 2];
      const luma = Math.round(0.299 * r + 0.587 * g + 0.114 * b);
      hist[luma]++;
      total++;
    }
    let entropy = 0;
    for (let i = 0; i < 256; i++) {
      if (hist[i] === 0) continue;
      const p = hist[i] / total;
      entropy -= p * Math.log2(p);
    }
    return entropy;
  } catch (err) {
    console.warn('Entropy estimate failed:', err);
    return 6.0;
  }
}

// --- Utilities ---
function loadImage(file) {
  return new Promise((resolve, reject) => {
    try {
      const reader = new FileReader();
      reader.onload = (e) => {
        const img = new Image();
        img.onload = () => resolve(img);
        img.onerror = (er) => reject(er);
        img.src = e.target.result;
      };
      reader.onerror = (e) => reject(e);
      reader.readAsDataURL(file);
    } catch (err) {
      reject(err);
    }
  });
}

function downloadCompressed() {
  if (!currentImage || !currentImage.compressed) return;
  const url = currentImage.compressedUrl || URL.createObjectURL(currentImage.compressed);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'compressed_' + currentImage.name;
  a.click();
  setTimeout(() => {
    try { URL.revokeObjectURL(url); } catch (e) {}
  }, 1000);
}

function closePreview() {
  previewModal.classList.remove('active');
  fileInput.value = '';
  if (currentImage && currentImage.compressedUrl) {
    try { URL.revokeObjectURL(currentImage.compressedUrl); } catch (e) {}
  }
  currentImage = null;
}

function formatBytes(bytes) {
  if (!bytes) return '0 Bytes';
  const k = 1024;
  const sizes = ['Bytes', 'KB', 'MB', 'GB'];
  const i = Math.floor(Math.log(bytes) / Math.log(k));
  return (bytes / Math.pow(k, i)).toFixed(2) + ' ' + sizes[i];
}

// --- Slider ---
function initSlider() {
  sliderHandle.addEventListener('mousedown', startDragging);
  sliderHandle.addEventListener('touchstart', startDragging, { passive: false });

  document.addEventListener('mousemove', drag);
  document.addEventListener('touchmove', drag, { passive: false });

  document.addEventListener('mouseup', stopDragging);
  document.addEventListener('touchend', stopDragging);
}

function startDragging(e) {
  isDragging = true;
  e.preventDefault();
}

function drag(e) {
  if (!isDragging) return;
  const container = document.getElementById('comparisonImages');
  const rect = container.getBoundingClientRect();
  const clientX = e.type.includes('touch') ? e.touches[0].clientX : e.clientX;
  const x = clientX - rect.left;
  const percentage = Math.max(0, Math.min(100, (x / rect.width) * 100));
  updateSliderPosition(percentage);
}

function stopDragging() {
  isDragging = false;
}

function updateSliderPosition(percentage) {
  sliderHandle.style.left = percentage + '%';
  compressedLayer.style.width = percentage + '%';
}

// --- Init ---
initSlider();

// expose controls
window.handleFile = handleFile;
window.downloadCompressed = downloadCompressed;
window.closePreview = closePreview;
</script>



</body>
</html>
